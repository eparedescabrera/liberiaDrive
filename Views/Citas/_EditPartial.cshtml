@model LiberiaDriveMVC.Models.Cita
@{
    Layout = null;
}

<h5 class="fw-bold text-primary mb-3">
    ‚úèÔ∏è Editar Cita
</h5>
<hr />

<form id="formEditarCita">
    <!-- ID de la cita -->
    <input type="hidden" name="IdCita" value="@Model.IdCita" />

    <!-- Cliente -->
    <div class="mb-3">
        <label class="form-label fw-bold">Cliente</label>
        <select id="clienteSelect" class="form-select" required>
            <option value="@Model.IdCliente" selected>@Model.ClienteNombre</option>
        </select>
        <!-- Hidden real que se env√≠a al backend -->
        <input type="hidden" id="hiddenClienteId" name="IdCliente" value="@Model.IdCliente" />
    </div>

    <!-- Tipo de Examen -->
    <div class="mb-3">
        <label class="form-label fw-bold">Tipo de Examen</label>
        <select name="TipoExamen" class="form-select" required>
            <option value="">Seleccione un tipo...</option>
            <option value="Te√≥rico" selected="@(Model.TipoExamen == "Te√≥rico")">Te√≥rico</option>
            <option value="Pr√°ctico" selected="@(Model.TipoExamen == "Pr√°ctico")">Pr√°ctico</option>
        </select>
    </div>

    <!-- Fecha -->
    <div class="mb-3">
        <label class="form-label fw-bold">Fecha de la Cita</label>
        <input type="datetime-local" name="FechaCita" class="form-control"
               value="@Model.FechaCita.ToString("yyyy-MM-ddTHH:mm")" required />
    </div>

    <!-- Estado -->
    <div class="mb-3">
        <label class="form-label fw-bold">Estado</label>
        <select name="Estado" class="form-select" required>
            <option value="Pendiente" selected="@(Model.Estado == "Pendiente")">Pendiente</option>
            <option value="Finalizado" selected="@(Model.Estado == "Finalizado")">Finalizado</option>
        </select>
    </div>

    <!-- Botones -->
    <div class="text-end">
        <button type="submit" class="btn btn-primary px-4">
            üíæ Guardar cambios
        </button>
        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
            Cancelar
        </button>
    </div>
</form>

@section Scripts {
<script>
    $(document).ready(function () {

        /* ========================================================
           üîç Inicializa Select2 con b√∫squeda AJAX
        ======================================================== */
        $("#clienteSelect").select2({
            theme: "bootstrap-5",
            placeholder: "Seleccione un cliente...",
            allowClear: true,
            ajax: {
                url: "/Citas/BuscarClientes",
                dataType: "json",
                delay: 250,
                data: function (params) {
                    return { term: params.term };
                },
                processResults: function (data) {
                    return { results: data };
                },
                cache: true
            },
            language: {
                inputTooShort: () => "Escriba al menos 1 car√°cter...",
                searching: () => "Buscando clientes...",
                noResults: () => "No se encontraron coincidencias"
            }
        });

        // üß© Sincroniza el valor del select con el input hidden real
        $("#clienteSelect").on("select2:select", function (e) {
            const data = e.params.data;
            $("#hiddenClienteId").val(data.id);
        });

        /* ========================================================
           üíæ Maneja el env√≠o del formulario v√≠a AJAX
        ======================================================== */
        $("#formEditarCita").off("submit").on("submit", function (e) {
            e.preventDefault();

            const data = $(this).serialize();
            console.log("‚û°Ô∏è Enviando datos de edici√≥n:", data);

            $.ajax({
                type: "POST",
                url: "/Citas/Edit",
                data: data,
                success: function (resp) {
                    console.log("Respuesta del servidor:", resp);

                    if (resp.success) {
                        $("#modalCita").modal("hide");
                        Swal.fire({
                            icon: "success",
                            title: "Cita actualizada correctamente",
                            timer: 1800,
                            showConfirmButton: false
                        }).then(() => location.reload());
                    } else {
                        Swal.fire("Error", resp.message || "No se pudo actualizar la cita.", "error");
                    }
                },
                error: function (xhr) {
                    console.error("‚ùå Error en el env√≠o AJAX:", xhr);
                    Swal.fire("Error", "Error inesperado al procesar la solicitud.", "error");
                }
            });
        });
    });
</script>
}
