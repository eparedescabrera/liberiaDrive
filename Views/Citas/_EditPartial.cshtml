@model LiberiaDriveMVC.Models.Cita

<form id="formEditarCita">
    <input type="hidden" asp-for="IdCita" />

    <div class="form-group mb-3">
        <label>Cliente</label>
        <select id="IdCliente" name="IdCliente" class="form-control select2" style="width: 100%;" required>
            @if (!string.IsNullOrEmpty(Model.ClienteNombre))
            {
                <option value="@Model.IdCliente" selected>@Model.ClienteNombre</option>
            }
        </select>
    </div>

    <div class="form-group mb-3">
        <label>Tipo de examen</label>
        <select asp-for="TipoExamen" class="form-control" required>
            <option value="">Seleccione...</option>
            <option value="Te√≥rico" selected="@((Model.TipoExamen == "Te√≥rico") ? "selected" : null)">Te√≥rico</option>
            <option value="Pr√°ctico" selected="@((Model.TipoExamen == "Pr√°ctico") ? "selected" : null)">Pr√°ctico</option>
        </select>
    </div>

    <div class="form-group mb-3">
        <label>Fecha de cita</label>
        <input asp-for="FechaCita" type="date" class="form-control" required min="@DateTime.Now.ToString("yyyy-MM-dd")" />
    </div>

    <div class="form-group mb-3">
        <label>Estado</label>
        <select asp-for="Estado" class="form-control" required>
            <option value="Pendiente" selected="@((Model.Estado == "Pendiente") ? "selected" : null)">Pendiente</option>
            <option value="Realizada" selected="@((Model.Estado == "Realizada") ? "selected" : null)">Realizada</option>
            <option value="Cancelada" selected="@((Model.Estado == "Cancelada") ? "selected" : null)">Cancelada</option>
        </select>
    </div>

    <div class="text-end">
        <button type="submit" class="btn btn-primary">üíæ Guardar cambios</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
    </div>
</form>

<script>
    // ================================
    // Inicializar Select2 AJAX Clientes
    // ================================
    $(document).ready(function () {
        $("#IdCliente").select2({
            dropdownParent: $('#modalCita'), // o el id del modal que uses
            ajax: {
                url: '/Citas/BuscarClientes',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return { term: params.term };
                },
                processResults: function (data) {
                    return { results: data };
                }
            },
            placeholder: 'Buscar cliente...',
            minimumInputLength: 1
        });
    });

    // ================================
    // Enviar formulario AJAX
    // ================================
    $(document).on("submit", "#formEditarCita", function (e) {
        e.preventDefault();

        const data = $(this).serialize();

        $.post("/Citas/Edit", data, function (resp) {
            if (resp.success) {
                mostrarResultado(resp, "Cita actualizada correctamente.");
            } else {
                mostrarError(resp.message);
            }
        });
    });

    // ================================
    // Funciones de feedback
    // ================================
    function mostrarResultado(resp, mensaje) {
        $("#modalCita").modal("hide");
        Swal.fire({
            icon: "success",
            title: "‚úÖ √âxito",
            text: mensaje,
            timer: 2000,
            showConfirmButton: false
        }).then(() => {
            location.reload();
        });
    }

    function mostrarError(mensaje) {
        Swal.fire({
            icon: "error",
            title: "‚ùå Error",
            text: mensaje
        });
    }
</script>
